<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>启动网页</title>
</head>

<body>
    电话号码：<input id="phone_num" value="15815949964" /><button
        onclick="post(`https:/`+`/ebike-client-prod2.xiaoantech.com/client/code/send`,{phone:`+86-`+document.querySelector('#phone_num').value,scene:1},()=>{log('Success.')})">
        获取验证码</button><br />
    验证码：<input id="check_num" /><button
        onclick="post(`https:/`+`/ebike-client-prod2.xiaoantech.com/oauth/token`,{phone:`+86-`+document.querySelector('#phone_num').value,messageCode:document.querySelector('#check_num').value,grant_type:'phone_code'},(data)=>{log('Success.');localStorage.User = 'Bearer '+data.data.accessToken})">
        验证验证码</button><br />
    运行：CarId: <input id="CarId" /><br />
    Key: <input id="key" /><br />
    运行类型：<button onclick="run(document.querySelector('#CarId').value,44,[0,0]);log('开车')">
        开车</button><button onclick="run(document.querySelector('#CarId').value,43,'');log('关车')">
        关车</button>
    </button>
    <button onclick="run(document.querySelector('#CarId').value,40,[255])">
        发声音</button><br /><br />
    <button onclick="localStorage.clear()">清除状态</button>
    <p>BLE_IDX_CONFIG: { START: 3, TEMP_LOCK: 7, LOCK: 1 },<br>
        BLE_CMD_CONFIG: {
        PLAY_VOICE: 40,
        GET_DEVICE_INFO: 65,
        START: 44,
        LOCK: 43,
        GET_LAST_BEACON_INFO: 66,
        GET_RFID: 84,
        SET_DASHBOARD: 106,
        },</p>
    <p>
        00："嘟"（小声）
        <br>
        01："已还车，请检查车筐，带好随身物品，期待我们再次相见"
        <br>
        02："开锁成功"
        <br>
        03："开始启动，请注意骑行安全哟"
        <br>
        04："登登登登"（大声）
        <br>
        05："欢迎使用共享电单车"
        <br>
        06：（警告声）【像动电单车的警告声】
        <br>
        07："临时锁车，等你回来哟"
        <br>
        08："服务区外暂时无法启动，请回到服务区内骑行"
        <br>
        09："我在这里"
        <br>
        0A："正在服务器边缘，超出服务区我会断电哟"
        <br>
        0B："这里禁止骑行，我断电了开启锁供电"
        <br>
        0C："还车归还失败，再试一次吧"
        <br>
        0D："还车失败，请垂直于停车线还车"
        <br>
        0F："超速啦，请减速注意安全"
        <br>
        10："我受伤了，请换一辆试试"
        <br>
        11："我没电了，请换一辆试试"
        <br>
        12："我已经被使用了，请让一让吧"
        <br>
        13："邻近服务区，车辆即将断电"
        <br>
        15："电池仓锁打开"
        <br>
        18：（扒拉~）[鬼知道什么声音]
        <br>
        1B："太好了，可以还车了"
        <br>
        1C："车辆即将断电，请佩戴好头盔"*2
        <br>
        1D："交警提醒您，请佩戴头盔，文明骑行"
        <br>
        1E："hey，我是...，请不要多人骑行哟"
        <br>
        1F："车辆已超载，即将断电"
        <br>
        21："我跌倒了，你可以扶我起来吗"
        <br>
        23："登录失败，再试一次吧"
        <br>
        24："头盔已佩戴，恢复骑行"
        <br>
        25："我已恢复正常，我们继续出发吧"
        <br>
        26："遵守交规，不要逆道而行哟"
        <br>
        27："对准还车标志线，再确认还车"
        <br>
        36: "电池仓锁打开"
        <br>
        37："为保障骑行安全，我断电了"
        <br>
        38："电门先关了，冷静下来再骑吧"
        <br>
        39: "电门已恢复，可以带我骑行了"
        <br>
        3A："车辆已过载，我断电了"
        <br>
        3B："请按压头盔，谢谢配合"
        <br>
        3C："不要乱开电门喔"
    </p>
    <div></div>

    <script>
        function run(Carid, key, typ) {
            post(
                "https://ebike-client-prod2.xiaoantech.com/client/rent/getCarInfo",
                {
                    carId: Carid,
                },
                (data) => {
                    post(
                        "https://ebike-client-prod2.xiaoantech.com/client/paas/device/getBlueToothToken",
                        {
                            imei: data.data.imei,
                        },
                        (data) => {
                            var token = (function (e) {
                                for (
                                    var t = parseInt(e).toString(16),
                                    n = "00000000",
                                    r = n.length - t.length,
                                    a = n.substr(0, r) + t,
                                    i = [],
                                    o = 0;
                                    o < a.length;
                                    o += 2
                                )
                                    i.push(parseInt(a.substring(o, o + 2), 16));
                                return i;
                            })(data.data.token);

                            var i, o, s, c, u, l;
                            for (
                                i = token, 
                                n = key, 
                                a = typ, 
                                o = 0,
                                s = void 0 !== a ? a.length : 0;
                                o < s;

                            )
                                i.push(a[o++]);
                            return (
                                (s = i.length),
                                (c = 0),
                                s > 0 &&
                                i.forEach(function (e) {
                                    c += e;
                                }, void 0),
                                (u = m(n + c + s)),
                                (l = _(i)),
                                log(m(n) + m(s) + l + u)
                            );
                        }
                    );
                }
            );
        }
        localStorage.User =
            "Basic MTE3NDp4aWFvYW50ZWNo";
        function log(data) {
            document.querySelector("div").innerText +=
                "[" + Date() + "] " + data + "\n";
        }
        function SHA256(s) {
            var chrsz = 8;
            var hexcase = 0;
            function safe_add(x, y) {
                var lsw = (x & 0xffff) + (y & 0xffff);
                var msw = (x >> 16) + (y >> 16) + (lsw >> 16);
                return (msw << 16) | (lsw & 0xffff);
            }
            function S(X, n) {
                return (X >>> n) | (X << (32 - n));
            }
            function R(X, n) {
                return X >>> n;
            }
            function Ch(x, y, z) {
                return (x & y) ^ (~x & z);
            }
            function Maj(x, y, z) {
                return (x & y) ^ (x & z) ^ (y & z);
            }
            function Sigma0256(x) {
                return S(x, 2) ^ S(x, 13) ^ S(x, 22);
            }
            function Sigma1256(x) {
                return S(x, 6) ^ S(x, 11) ^ S(x, 25);
            }
            function Gamma0256(x) {
                return S(x, 7) ^ S(x, 18) ^ R(x, 3);
            }
            function Gamma1256(x) {
                return S(x, 17) ^ S(x, 19) ^ R(x, 10);
            }
            function core_sha256(m, l) {
                var K = new Array(
                    0x428a2f98,
                    0x71374491,
                    0xb5c0fbcf,
                    0xe9b5dba5,
                    0x3956c25b,
                    0x59f111f1,
                    0x923f82a4,
                    0xab1c5ed5,
                    0xd807aa98,
                    0x12835b01,
                    0x243185be,
                    0x550c7dc3,
                    0x72be5d74,
                    0x80deb1fe,
                    0x9bdc06a7,
                    0xc19bf174,
                    0xe49b69c1,
                    0xefbe4786,
                    0xfc19dc6,
                    0x240ca1cc,
                    0x2de92c6f,
                    0x4a7484aa,
                    0x5cb0a9dc,
                    0x76f988da,
                    0x983e5152,
                    0xa831c66d,
                    0xb00327c8,
                    0xbf597fc7,
                    0xc6e00bf3,
                    0xd5a79147,
                    0x6ca6351,
                    0x14292967,
                    0x27b70a85,
                    0x2e1b2138,
                    0x4d2c6dfc,
                    0x53380d13,
                    0x650a7354,
                    0x766a0abb,
                    0x81c2c92e,
                    0x92722c85,
                    0xa2bfe8a1,
                    0xa81a664b,
                    0xc24b8b70,
                    0xc76c51a3,
                    0xd192e819,
                    0xd6990624,
                    0xf40e3585,
                    0x106aa070,
                    0x19a4c116,
                    0x1e376c08,
                    0x2748774c,
                    0x34b0bcb5,
                    0x391c0cb3,
                    0x4ed8aa4a,
                    0x5b9cca4f,
                    0x682e6ff3,
                    0x748f82ee,
                    0x78a5636f,
                    0x84c87814,
                    0x8cc70208,
                    0x90befffa,
                    0xa4506ceb,
                    0xbef9a3f7,
                    0xc67178f2
                );
                var HASH = new Array(
                    0x6a09e667,
                    0xbb67ae85,
                    0x3c6ef372,
                    0xa54ff53a,
                    0x510e527f,
                    0x9b05688c,
                    0x1f83d9ab,
                    0x5be0cd19
                );
                var W = new Array(64);
                var a, b, c, d, e, f, g, h, i, j;
                var T1, T2;
                m[l >> 5] |= 0x80 << (24 - (l % 32));
                m[(((l + 64) >> 9) << 4) + 15] = l;
                for (var i = 0; i < m.length; i += 16) {
                    a = HASH[0];
                    b = HASH[1];
                    c = HASH[2];
                    d = HASH[3];
                    e = HASH[4];
                    f = HASH[5];
                    g = HASH[6];
                    h = HASH[7];
                    for (var j = 0; j < 64; j++) {
                        if (j < 16) W[j] = m[j + i];
                        else
                            W[j] = safe_add(
                                safe_add(
                                    safe_add(Gamma1256(W[j - 2]), W[j - 7]),
                                    Gamma0256(W[j - 15])
                                ),
                                W[j - 16]
                            );
                        T1 = safe_add(
                            safe_add(
                                safe_add(safe_add(h, Sigma1256(e)), Ch(e, f, g)),
                                K[j]
                            ),
                            W[j]
                        );
                        T2 = safe_add(Sigma0256(a), Maj(a, b, c));
                        h = g;
                        g = f;
                        f = e;
                        e = safe_add(d, T1);
                        d = c;
                        c = b;
                        b = a;
                        a = safe_add(T1, T2);
                    }
                    HASH[0] = safe_add(a, HASH[0]);
                    HASH[1] = safe_add(b, HASH[1]);
                    HASH[2] = safe_add(c, HASH[2]);
                    HASH[3] = safe_add(d, HASH[3]);
                    HASH[4] = safe_add(e, HASH[4]);
                    HASH[5] = safe_add(f, HASH[5]);
                    HASH[6] = safe_add(g, HASH[6]);
                    HASH[7] = safe_add(h, HASH[7]);
                }
                return HASH;
            }
            function str2binb(str) {
                var bin = Array();
                var mask = (1 << chrsz) - 1;
                for (var i = 0; i < str.length * chrsz; i += chrsz) {
                    bin[i >> 5] |=
                        (str.charCodeAt(i / chrsz) & mask) << (24 - (i % 32));
                }
                return bin;
            }
            function Utf8Encode(string) {
                string = string.replace(/\r\n/g, "\n");
                var utftext = "";
                for (var n = 0; n < string.length; n++) {
                    var c = string.charCodeAt(n);
                    if (c < 128) {
                        utftext += String.fromCharCode(c);
                    } else if (c > 127 && c < 2048) {
                        utftext += String.fromCharCode((c >> 6) | 192);
                        utftext += String.fromCharCode((c & 63) | 128);
                    } else {
                        utftext += String.fromCharCode((c >> 12) | 224);
                        utftext += String.fromCharCode(((c >> 6) & 63) | 128);
                        utftext += String.fromCharCode((c & 63) | 128);
                    }
                }
                return utftext;
            }
            function binb2hex(binarray) {
                var hex_tab = hexcase ? "0123456789ABCDEF" : "0123456789abcdef";
                var str = "";
                for (var i = 0; i < binarray.length * 4; i++) {
                    str +=
                        hex_tab.charAt(
                            (binarray[i >> 2] >> ((3 - (i % 4)) * 8 + 4)) & 0xf
                        ) +
                        hex_tab.charAt((binarray[i >> 2] >> ((3 - (i % 4)) * 8)) & 0xf);
                }
                return str;
            }
            s = Utf8Encode(s);
            return binb2hex(core_sha256(str2binb(s), s.length * chrsz));
        }
        function m(e) {
            return ("0" + (255 & e).toString(16)).slice(-2);
        }
        function _(e) {
            return Array.from(e, function (e) {
                return m(e);
            }).join("");
        }
        function post(url, body, ret) {
            var httpRequest = new XMLHttpRequest();
            var time = Date.now();
            var send = {
                ...{
                    traceId: time + "" + Math.floor(Math.random() * 1e11),
                    tenantId: "651",
                },
                ...body,
            };
            httpRequest.open("POST", url, true);
            httpRequest.setRequestHeader("Content-Type", "application/json");
            httpRequest.setRequestHeader("_t", time);
            httpRequest.setRequestHeader(
                "_s",
                SHA256(
                    JSON.stringify(send) +
                    "_t=" +
                    time +
                    "baaa736828207439964309efde598b2a6ca3d9888cb6f1eaa03b2799b8c6780c"
                )
            );
            localStorage.User && httpRequest.setRequestHeader("Authorization", localStorage.User);

            httpRequest.onreadystatechange = function () {
                log("Post " + url + " " + httpRequest.responseText);
                if (httpRequest.readyState == 4 && httpRequest.status == 200) {
                    var data = JSON.parse(httpRequest.responseText);
                    ret(data);
                } else console.log(url, data);
            };
            httpRequest.send(JSON.stringify(send));
        }
        function first(t, n, a) {
            for (i = e.sent, o = 0, s = void 0 !== a ? a.length : 0; o < s;)
                i.push(a[o++]);
            return (
                (s = i.length),
                (c = 0),
                s > 0 &&
                i.forEach(function (e) {
                    c += e;
                }, void 0),
                (u = m(n + c + s)),
                (l = _(i)),
                m(n) + m(s) + l + u
            );
        }
    </script>
</body>

</html>
